#!snabb snsh

-- Use of this source code is governed by the GNU AGPL license; see COPYING.

local vita_test = require("program.vita.test")

-- Synopsis:
--
--    sudo program/vita/test.snabb \
--       [<packet-size>|IMIX] [<nroutes>] [<sa-ttl>]\
--       [<cpuspec>] \
--       [<accuracy>] [<initial-rate>] [<plateau-duration>]
--
--     Defaults to IMIX via one route with SA ttl of 16s (rekey every 8s).
--     Optionally, accepts a comma-separated list of CPU ids to bind processes
--     to. (-:
--
-- This is a software-only benchmark scenario for Vita. It simulates a single
-- Vita node with the public ports being connected in loop-back mode (i.e.,
-- routes lead to itself). Synthetic traffic is injected into the private input
-- port, and throughput is measured at the private output port.
--
-- This benchmark exponentially increases the throughput starting at
-- <initial-rate> (default: 100e6 / 100 Mbps) until it finds the partial drop
-- rate (PDR) defined by <accuracy> (default: .01 / 1%). Finally, it measures
-- throughput at the approximate PDR for <plateau-duration> (default: 5s).
--
-- Here is a diagram of the app graph implemented in this test case:
--
--         +----------+
--         |          |
--         |  Source  +-----+
--         |          |     |
--         +----------+     |           +--------------+
--               ^          |           |              |
--               :          +----------->              +---------+
-- controls rate :              private |     Vita     | public  |
--               :          +-----------+              <---------+
--         +-----------+    |           |              |
--         |           |    |           +--------------+
--         |   Gauge   <----+
--         |           |  ^
--         +-----------+  :....(throughput measured here)
--
-- While this benchmark should be suitable to evaluate relative performance
-- differences between Vita versions, it is not representative of real-world
-- performance since it does not involve NIC drivers present in an actual L2
-- network.
--
-- For a more realistic test case use genconf.snabb and genpcap.snabb in
-- conjunction with snabb loadtest.

local testcfg = {
   packet_size = tonumber(main.parameters[1]) or main.parameters[1],
   nroutes = tonumber(main.parameters[2]),
   sa_ttl = tonumber(main.parameters[3]),
}

local cpuspec = main.parameters[4]

local gaugecfg = {
   accuracy = tonumber(main.parameters[5]),
   initial_rate = tonumber(main.parameters[6]),
   plateau_duration = tonumber(main.parameters[7])
}

vita_test.run_softbench(testcfg, gaugecfg, cpuspec)
